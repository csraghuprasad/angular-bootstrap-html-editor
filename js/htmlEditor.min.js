angular.module("htmlEditor",[]).directive("htmlEditor",["$timeout","$compile","getColor",function(b,a,c){return{restrict:"EA",scope:{htmlData:"=",eRequired:"="},replace:true,template:'<div><div class="head"><div class="btn-group" ng-mousedown="checkFocus()"><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.bold.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'bold\')" ng-if="commands.bold.support" data-toggle="tooltip" title="Bold"><i class="glyphicon glyphicon-bold"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.italic.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'italic\')" ng-if="commands.italic.support" data-toggle="tooltip" title="Italic"><i class="glyphicon glyphicon-italic"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'indent\')" ng-if="commands.indent.support" data-toggle="tooltip" title="Indent"><i class="glyphicon glyphicon-indent-left"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'outdent\')" ng-if="commands.outdent.support" data-toggle="tooltip" title="Outdent"><i class="glyphicon glyphicon-indent-right"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyLeft.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyLeft\')" ng-if="commands.justifyLeft.support" data-toggle="tooltip" title="Justify Left"><i class="glyphicon glyphicon-align-left"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyCenter.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyCenter\')" ng-if="commands.justifyCenter.support" data-toggle="tooltip" title="Justify Center"><i class="glyphicon glyphicon-align-center"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyRight.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyRight\')" ng-if="commands.justifyRight.support" data-toggle="tooltip" title="Justify Right"><i class="glyphicon glyphicon-align-right"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyFull.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyFull\')" ng-if="commands.justifyFull.support" data-toggle="tooltip" title="Justify Full"><i class="glyphicon glyphicon-align-justify"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertHorizontalRule\')" ng-if="commands.insertHorizontalRule.support" data-toggle="tooltip" title="Horizontal Rule">HR</button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.strikeThrough.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'strikeThrough\')" ng-if="commands.strikeThrough.support" data-toggle="tooltip" title="Strike Through"><span style="text-decoration: line-through;">S</span></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.subscript.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'subscript\')" ng-if="commands.subscript.support" data-toggle="tooltip" title="Subscript"><i class="glyphicon glyphicon-subscript"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.superscript.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'superscript\')" ng-if="commands.superscript.support" data-toggle="tooltip" title="Superscript"><i class="glyphicon glyphicon-superscript"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.underline.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'underline\')" ng-if="commands.underline.support" data-toggle="tooltip" title="Underline"><span style="text-decoration: underline;">U</span></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.foreColor.enabled}" onmousedown="event.preventDefault();" ng-click="getColor()" ng-if="commands.foreColor.support" data-toggle="tooltip" title="Text Color"><i class="glyphicon glyphicon-text-color"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.backColor.enabled}" onmousedown="event.preventDefault();" ng-click="getColor(1)" ng-if="commands.backColor.support" data-toggle="tooltip" title="Background Color"><i class="glyphicon glyphicon-text-background"></i></button><div class="btn-group" ng-if="commands.insertOrderedList.support" data-toggle="tooltip" title="List"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-list"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertUnorderedList\',\'disc\')"><a>Circle</a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertOrderedList\',\'decimal\')"><a>Number</a></li></ul></div><div class="btn-group" ng-if="commands.fontName.support" data-toggle="tooltip" title="Font Name"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-font"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontName\',font)" ng-repeat="font in FONTS | orderBy"><a ng-attr-style="{{\'font-family:\'+font}}" ng-bind="font"></a></li></ul></div><div class="btn-group" ng-if="commands.fontSize.support" data-toggle="tooltip" title="Font Size"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-text-size"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',6)"><a><font size="6">Size 6</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',5)"><a><font size="5">Size 5</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',4)"><a><font size="4">Size 4</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',3)"><a><font size="3">Size 3</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',2)"><a><font size="2">Size 2</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',1)"><a><font size="1">Size 1</font></a></li></ul></div><div class="btn-group" ng-if="commands.heading.support" data-toggle="tooltip" title="Heading"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown">H <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h1\')"><h1><a>heading 1</a></h1></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h2\')"><h2><a>heading 2</a></h2>></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h3\')"><h3><a>heading 3</a></h3></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h4\')"><h4><a>heading 4</a></h4></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h5\')"><h5><a>heading 5</a></h5></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h6\')"><h6><a>heading 6</a></h6></li></ul></div><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.createLink.support  && !is_ie" data-toggle="tooltip" title="Link" ng-click="showLinkModal()"><i class="glyphicon glyphicon-link"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.unlink.support && !is_ie" data-toggle="tooltip" title="Unlink" ng-click="exeCmd(\'unlink\')"><i class="glyphicon glyphicon-link"  style="text-decoration: line-through;"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.insertImage.support && !is_ie" data-toggle="tooltip" title="Image"  ng-click="showImgModal()"><i class="glyphicon glyphicon-picture"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.selectAll.support" data-toggle="tooltip" title="Select All" ng-click="exeCmd(\'selectAll\')"><i class="glyphicon glyphicon-move"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.undo.support" data-toggle="tooltip" title="Undo" ng-click="exeCmd(\'undo\')"><i class="glyphicon glyphicon-repeat flip"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.redo.support" data-toggle="tooltip" title="Redo" ng-click="exeCmd(\'redo\')"><i class="glyphicon glyphicon-repeat"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.removeFormat.support"  data-toggle="tooltip" title="Remove Format" ng-click="exeCmd(\'removeFormat\')"><i class="glyphicon glyphicon-remove"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-disabled="!htmlData" data-toggle="tooltip" title="Preview" ng-click="showPreview()"><i class="glyphicon glyphicon-eye-open"></i></bu></div></div><div contenteditable="true" class="html-editor" spellcheck="false" ng-class="{\'ng-invalid\':eRequired && !htmlData}"></div><div class="foot"><span ng-bind="count?count:0"></span> Word<span ng-bind="count>1?(\'s\'):\'\'"></span></div></div>',link:function(p,l){p.is_ie=/MSIE|Trident/.test(window.navigator.userAgent);p.is_ff=navigator.userAgent.indexOf("Firefox")!=-1;var h,i=$(l).find(".html-editor")[0];p.local=false;if(p.is_ie){$(i).on("input keydown click change",function(){f();g();k()})}else{$(i).on("input click",function(){f();g();k()})}$(i).on("paste",function(u){var v=u.originalEvent.clipboardData||window.clipboardData;u.preventDefault();u.stopPropagation();var r=v.getData("text");if(r){if(p.is_ie){var w=r.split(/\r?\n/);r="<span>"+w[0]+"</span>";for(var t=1;t<w.length;t++){r=r+"<div>"+w[t]+"</div>"}q(r);g()}else{var s=v.getData("text/html");if(s.indexOf("he-e")>-1&&document.queryCommandSupported("insertHTML")){document.execCommand("insertHTML",false,s)}else{document.execCommand("insertText",false,r)}}}}).on("drop",function(r){r.preventDefault();r.stopPropagation()}).on("dragenter",function(r){r.preventDefault()}).on("dragover",function(r){r.preventDefault()}).on("keydown",function(s){var r=s.keyCode||s.which;if(s.shiftKey&&s.keyCode===9){s.preventDefault();p.exeCmd("outdent")}else{if(r==9){s.preventDefault();p.exeCmd("indent")}}}).on("click","img",function(r){p.range=j();p.showImgModal($(this));p.$apply()}).on("click","a",function(r){p.range=j();p.showLinkModal($(this));p.$apply()});p.checkFocus=function(){if(!$(i).is(":focus")){$(i).focus()}};p.exeCmd=function(t,s){if(p.is_ie&&t=="outdent"){var r=window.getSelection().focusNode.parentNode;$(r).closest("blockquote").css("margin","0")}document.execCommand(t,false,s);g();f()};p.showLinkModal=function(r){p.range=j();p.link="";p.linkE=r;if(r){p.link=r.attr("href")}b(function(){var s=$('<div class="html-preview"></div>');$(s).append('<div class="frame f"><h4 class="mb-10 text-center">Add Link</h4><form name="linkForm" ng-submit="closeLinkModal(linkForm,link,$event)" novalidate><label>Link URL</label><input type="text" class="form-control input-sm" ng-pattern="pat.linkUrl" ng-model="link" required /><div class="mt-15 text-right"><button class="btn btn-xs btn-default sharp remove" type="reset" style="margin-right: 5px">Cancel</button><button class="btn btn-xs btn-info sharp" type="submit">Add Link</button></div></div></form></div>');$("body").append(s).addClass("hp");a(s)(p);$(s).on("click",".remove",function(t){$(s).remove();e(p.range);$("body").removeClass("hp")})})};p.closeLinkModal=function(t,v,u){if(t.$invalid){return}e(p.range);var s=angular.element(u.target);$(s).closest(".html-preview").remove();$("body").removeClass("hp");if(p.linkE){p.range.selectNode(p.linkE[0]);p.exeCmd("createLink",v)}else{if(!v.toUpperCase().startsWith("HTTP://")&&!v.toUpperCase().startsWith("HTTPS://")){v="http://"+v}var r='<a href="'+v+'">'+(n()||v)+"</a>";p.exeCmd("insertHTML",r)}};p.showImgModal=function(s){p.range=j();p.imgE=s;p.image={WIDTH_AUTO:true};if(s){var r=s.attr("width");if(typeof r!==typeof undefined&&r!==false){p.image.WIDTH_AUTO=false;p.image.WIDTH=s.attr("width")}p.image.URL=s.attr("src");p.image.ALT=s.attr("alt")}b(function(){var t=$('<div class="html-preview"></div>');$(t).append('<div class="frame f"><h4 class="mb-10 text-center">Add Image</h4><form name="imageForm" ng-submit="closeImgModal(imageForm,image,$event)" novalidate><div class="row"><div class="col-xs-12 mb-15"><label>Image URL</label><input type="text" class="form-control input-sm" ng-pattern="pat.imageUrl" ng-model="image.URL" required></div></div><div class="row"><div class="col-xs-6"><label>Title</label><input type="text" class="form-control input-sm" ng-model="image.ALT"></div><div class="col-xs-6"><label>Width</label><input type="text" class="form-control input-sm" ng-model="image.WIDTH" required ng-if="!image.WIDTH_AUTO" inp-validation="onlyDigits" maxlength="3"><p class="mt-5"><label class="checkbox-inline f-14"><input type="checkbox" ng-model="image.WIDTH_AUTO"> <span>Auto Width</span></label><p></div></div><div class="mt-15 text-right"><button class="btn btn-xs btn-default sharp remove" type="reset"  style="margin-right: 5px">Cancel</button><button class="btn btn-xs btn-info sharp" type="submit">Add Image</button></div></form></div>');$("body").append(t).addClass("hp");a(t)(p);$(t).on("click",".remove",function(u){$(t).remove();e(p.range);$("body").removeClass("hp")})})};p.closeImgModal=function(t,v,u){if(t.$invalid){return}e(p.range);var s=angular.element(u.target);$(s).closest(".html-preview").remove();$("body").removeClass("hp");if(p.imgE){p.range.selectNode(p.imgE[0]);p.exeCmd("delete",0,null)}var r='<img src="'+v.URL+'"'+(v.ALT?('alt="'+v.ALT+'"'):"")+(!v.WIDTH_AUTO?('width="'+v.WIDTH+'"'):"")+"/>";p.exeCmd("insertHTML",r)};p.getColor=function(r){p.range=j();c.get(function(s){e(p.range);if(r){p.exeCmd("backColor",s)}else{p.exeCmd("foreColor",s)}})};p.$watch("htmlData",function(){if(!p.local){p.setData(i)}else{p.local=false}});p.setData=function(r){$(r).html(p.htmlData||"");$(r).find("*").addClass("he-e");if(p.is_ie||p.is_ff){o(r,1)}k()};p.getData=function(){var r=$(i).clone();$(r).find("*").removeAttr("class");if(p.is_ie||p.is_ff){d(r[0],1);p.htmlData=$(r).html()}else{p.htmlData=$(r).html()}r=""};p.showPreview=function(){var r=$('<div class="html-preview"></div>');$(r).append('<p class="text-right mb-10 f-16"><i class="glyphicon glyphicon-remove pointer c-white remove"></i></p><div class="frame">'+p.htmlData+"</div>");$("body").append(r).addClass("hp");$(r).on("click",".remove",function(s){$(r).remove();$("body").removeClass("hp")})};p.pat={imageUrl:/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+(?:png|jpg|jpeg|gif|svg)+$/,linkUrl:/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/};p.commands={backColor:{cmd:"backColor",val:"color"},bold:{cmd:"bold"},copy:{cmd:"copy"},createLink:{cmd:"createLink"},formatBlock:{cmd:"formatBlock"},cut:{cmd:"cut"},"delete":{cmd:"delete"},fontName:{cmd:"fontName"},fontSize:{cmd:"fontSize"},foreColor:{cmd:"foreColor"},forwardDelete:{cmd:"forwardDelete"},indent:{cmd:"indent"},insertHorizontalRule:{cmd:"insertHorizontalRule"},insertImage:{cmd:"insertImage"},insertOrderedList:{cmd:"insertOrderedList"},insertUnorderedList:{cmd:"insertUnorderedList"},insertParagraph:{cmd:"insertParagraph"},insertText:{cmd:"insertText"},italic:{cmd:"italic"},justifyCenter:{cmd:"justifyCenter"},justifyFull:{cmd:"justifyFull"},justifyLeft:{cmd:"justifyLeft"},justifyRight:{cmd:"justifyRight"},outdent:{cmd:"outdent"},paste:{cmd:"paste"},redo:{cmd:"redo"},removeFormat:{cmd:"removeFormat"},selectAll:{cmd:"selectAll"},strikeThrough:{cmd:"strikeThrough"},subscript:{cmd:"subscript"},superscript:{cmd:"superscript"},underline:{cmd:"underline"},undo:{cmd:"undo"},unlink:{cmd:"unlink"},insertHTML:{cmd:"insertHTML"},heading:{cmd:"heading"}};p.FONTS=["Arial","Helvetica","Times New Roman","Times","Courier New","Courier","Verdana","Georgia","Palatino","Garamond","Bookman","Comic Sans MS","Trebuchet MS","Arial Black","Impact"];for(var m in p.commands){p.commands[m].support=document.queryCommandSupported(m)}function j(){if(window.getSelection){h=window.getSelection();if(h.getRangeAt&&h.rangeCount){return h.getRangeAt(0)}}else{if(document.selection&&document.selection.createRange){return document.selection.createRange()}}return null}function e(r){if(r){if(window.getSelection){h=window.getSelection();h.removeAllRanges();h.addRange(r)}else{if(document.selection&&r.select){r.select()}}}}function g(){for(var r in p.commands){if(document.queryCommandSupported(r)){p.commands[r].enabled=document.queryCommandState(r)}}}function f(){$(i).find("*").addClass("he-e");$(i).find("blockquote").css({"font-size":"inherit",border:"0 solid transparent",padding:"0",margin:"0 0 0 20px"});$(i).find("a").attr("target","_blank");p.local=true;p.getData()}function n(){var r="";if(window.getSelection){r=window.getSelection().toString()}else{if(document.selection&&document.selection.type!="Control"){r=document.selection.createRange().text}}return r}function q(t,r){var x,s;if(window.getSelection){x=window.getSelection();if(x.getRangeAt&&x.rangeCount){s=x.getRangeAt(0);s.deleteContents();var u=document.createElement("div");if(r){u.textContent=t}else{u.innerHTML=t}var y=document.createDocumentFragment(),w,v;while((w=u.firstChild)){v=y.appendChild(w)}s.insertNode(y);if(v){s=s.cloneRange();s.setStartAfter(v);s.collapse(true);x.removeAllRanges();x.addRange(s)}}}}function d(t,s){if(!s&&t.nodeType==1&&!/(script|style)/i.test(t.tagName)){var r=$(t).attr("align");if(typeof r!==typeof undefined&&r!==false){if(r!="left"){$(t).css("text-align",r)}$(t).removeAttr("align")}}$.each(t.childNodes,function(u,v){d(v)})}function o(t,s){if(!s&&t.nodeType==1&&!/(script|style)/i.test(t.tagName)){if($(t).attr("style")&&$(t).attr("style").indexOf("text-align")!=-1){var r=$(t).css("text-align");if(r){if(r.indexOf("center")!=-1){$(t).attr("align","center")}else{if(r.indexOf("right")!=-1){$(t).attr("align","right")}else{$(t).attr("align","left")}}$(t).css("text-align","")}}}$.each(t.childNodes,function(u,v){o(v)})}function k(){b(function(){var r=i.textContent.trim();p.count=r.length?r.replace(/\s+/g," ").split(" ").length:0})}$(document).ready(function(){$('[data-toggle="tooltip"]').tooltip("destroy").tooltip({container:"body"});if(p.is_ie){function s(u){u.preventDefault()}document.body.addEventListener("mscontrolselect",s)}try{var r=document.createElement("input");r.type="color";r.value="!";if(r.type==="color"&&r.value!=="!"){p.commands.foreColor.support=true;p.commands.backColor.support=true}}catch(t){}})}}}]).factory("getColor",function(){return{get:function(c){var b=$("#getColor");if(!b.length){b=$('<input type="color" id="getColor" style="display:none">');$("body").append(b)}b.unbind("change");b.change(function a(){if(this.value){c(this.value)}this.value=""});b.click()}}});