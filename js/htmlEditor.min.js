angular.module("htmlEditor",[]).directive("htmlEditor",["$timeout","$compile","getColor",function(b,a,c){return{restrict:"EA",scope:{htmlData:"=",eRequired:"="},replace:true,template:'<div><div class="head"><div class="btn-group" ng-mousedown="checkFocus()"><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.bold.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'bold\')" ng-if="commands.bold.support" data-toggle="tooltip" title="Bold"><i class="glyphicon glyphicon-bold"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.italic.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'italic\')" ng-if="commands.italic.support" data-toggle="tooltip" title="Italic"><i class="glyphicon glyphicon-italic"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'indent\')" ng-if="commands.indent.support" data-toggle="tooltip" title="Indent"><i class="glyphicon glyphicon-indent-left"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'outdent\')" ng-if="commands.outdent.support" data-toggle="tooltip" title="Outdent"><i class="glyphicon glyphicon-indent-right"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyLeft.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyLeft\')" ng-if="commands.justifyLeft.support" data-toggle="tooltip" title="Justify Left"><i class="glyphicon glyphicon-align-left"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyCenter.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyCenter\')" ng-if="commands.justifyCenter.support" data-toggle="tooltip" title="Justify Center"><i class="glyphicon glyphicon-align-center"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyRight.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyRight\')" ng-if="commands.justifyRight.support" data-toggle="tooltip" title="Justify Right"><i class="glyphicon glyphicon-align-right"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.justifyFull.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'justifyFull\')" ng-if="commands.justifyFull.support" data-toggle="tooltip" title="Justify Full"><i class="glyphicon glyphicon-align-justify"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertHorizontalRule\')" ng-if="commands.insertHorizontalRule.support" data-toggle="tooltip" title="Horizontal Rule"><i class="glyphicon glyphicon-resize-horizontal"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.strikeThrough.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'strikeThrough\')" ng-if="commands.strikeThrough.support" data-toggle="tooltip" title="Strike Through"><span style="text-decoration: line-through;">S</span></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.subscript.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'subscript\')" ng-if="commands.subscript.support" data-toggle="tooltip" title="Subscript"><i class="glyphicon glyphicon-subscript"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.superscript.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'superscript\')" ng-if="commands.superscript.support" data-toggle="tooltip" title="Superscript"><i class="glyphicon glyphicon-superscript"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.underline.enabled}" onmousedown="event.preventDefault();" ng-click="exeCmd(\'underline\')" ng-if="commands.underline.support" data-toggle="tooltip" title="Underline"><span style="text-decoration: underline;">U</span></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.foreColor.enabled}" onmousedown="event.preventDefault();" ng-click="getColor()" ng-if="commands.foreColor.support" data-toggle="tooltip" title="Text Color"><i class="glyphicon glyphicon-text-color"></i></button><button type="button" class="btn btn-xs btn-default sharp" ng-class="{\'active\':commands.backColor.enabled}" onmousedown="event.preventDefault();" ng-click="getColor(1)" ng-if="commands.backColor.support" data-toggle="tooltip" title="Background Color"><i class="glyphicon glyphicon-text-background"></i></button><div class="btn-group" ng-if="commands.insertOrderedList.support" data-toggle="tooltip" title="List"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-list"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertUnorderedList\',\'disc\')"><a>Circle</a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'insertOrderedList\',\'decimal\')"><a>Number</a></li></ul></div><div class="btn-group" ng-if="commands.fontName.support" data-toggle="tooltip" title="Font Name"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-font"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontName\',font)" ng-repeat="font in FONTS | orderBy"><a ng-attr-style="{{\'font-family:\'+font}}" ng-bind="font"></a></li></ul></div><div class="btn-group" ng-if="commands.fontSize.support" data-toggle="tooltip" title="Font Size"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown"><i class="glyphicon glyphicon-text-size"></i> <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',6)"><a><font size="6">Size 6</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',5)"><a><font size="5">Size 5</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',4)"><a><font size="4">Size 4</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',3)"><a><font size="3">Size 3</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',2)"><a><font size="2">Size 2</font></a></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'fontSize\',1)"><a><font size="1">Size 1</font></a></li></ul></div><div class="btn-group" ng-if="commands.heading.support" data-toggle="tooltip" title="Heading"><button type="button" class="btn btn-xs btn-default sharp dropdown-toggle" data-toggle="dropdown">H <span class="caret"></span></button><ul class="dropdown-menu"><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h1\')"><h1><a>heading 1</a></h1></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h2\')"><h2><a>heading 2</a></h2>></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h3\')"><h3><a>heading 3</a></h3></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h4\')"><h4><a>heading 4</a></h4></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h5\')"><h5><a>heading 5</a></h5></li><li onmousedown="event.preventDefault();" ng-click="exeCmd(\'heading\',\'h6\')"><h6><a>heading 6</a></h6></li></ul></div><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.createLink.support  && !is_ie" data-toggle="tooltip" title="Link" ng-click="showLinkModal()"><i class="glyphicon glyphicon-link"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.unlink.support && !is_ie" data-toggle="tooltip" title="Unlink" ng-click="exeCmd(\'unlink\')"><i class="glyphicon glyphicon-link"  style="text-decoration: line-through;"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.insertImage.support && !is_ie" data-toggle="tooltip" title="Image"  ng-click="showImgModal()"><i class="glyphicon glyphicon-picture"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.selectAll.support" data-toggle="tooltip" title="Select All" ng-click="exeCmd(\'selectAll\')"><i class="glyphicon glyphicon-move"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.undo.support" data-toggle="tooltip" title="Undo" ng-click="exeCmd(\'undo\')"><i class="glyphicon glyphicon-repeat flip"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.redo.support" data-toggle="tooltip" title="Redo" ng-click="exeCmd(\'redo\')"><i class="glyphicon glyphicon-repeat"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-if="commands.removeFormat.support"  data-toggle="tooltip" title="Remove Format" ng-click="exeCmd(\'removeFormat\')"><i class="glyphicon glyphicon-remove"></i></button><button type="button" class="btn btn-xs btn-default sharp" onmousedown="event.preventDefault();" ng-disabled="!htmlData" data-toggle="tooltip" title="Preview" ng-click="showPreview()"><i class="glyphicon glyphicon-eye-open"></i></bu></div></div><div contenteditable="true" class="html-editor" spellcheck="false" ng-class="{\'ng-invalid\':eRequired && !htmlData}"></div><div class="foot"><span ng-bind="count?count:0"></span> Word<span ng-bind="count>1?(\'s\'):\'\'"></span></div></div>',link:function(q,m){q.is_ie=/MSIE|Trident/.test(window.navigator.userAgent);q.is_ff=navigator.userAgent.indexOf("Firefox")!=-1;q.words=[];var i,j=$(m).find(".html-editor")[0];q.local=false;if(q.is_ie){$(j).on("input keydown click change",function(){f();g();l()})}else{$(j).on("input click",function(){f();g();l()})}$(j).on("paste",function(v){var w=v.originalEvent.clipboardData||window.clipboardData;v.preventDefault();v.stopPropagation();var s=w.getData("text");if(s){if(q.is_ie){var x=s.split(/\r?\n/);s="<span>"+x[0]+"</span>";for(var u=1;u<x.length;u++){s=s+"<div>"+x[u]+"</div>"}r(s);g()}else{var t=w.getData("text/html");if(t.indexOf("he-e")>-1&&document.queryCommandSupported("insertHTML")){document.execCommand("insertHTML",false,t)}else{document.execCommand("insertText",false,s)}}}}).on("drop",function(s){s.preventDefault();s.stopPropagation()}).on("dragenter",function(s){s.preventDefault()}).on("dragover",function(s){s.preventDefault()}).on("keydown",function(t){var s=t.keyCode||t.which;if(t.shiftKey&&t.keyCode===9){t.preventDefault();q.exeCmd("outdent")}else{if(s==9){t.preventDefault();q.exeCmd("indent")}}}).on("click","img",function(s){q.range=k();q.showImgModal($(this));q.$apply()}).on("click","a",function(s){q.range=k();q.showLinkModal($(this));q.$apply()});q.checkFocus=function(){if(!$(j).is(":focus")){$(j).focus()}};q.exeCmd=function(u,t){if(q.is_ie&&u=="outdent"){var s=window.getSelection().focusNode.parentNode;$(s).closest("blockquote").css("margin","0")}document.execCommand(u,false,t);g();f()};q.showLinkModal=function(s){q.range=k();q.link="";q.linkE=s;if(s){q.link=s.attr("href")}b(function(){var t=$('<div class="html-preview"></div>');$(t).append('<div class="frame f"><h4 class="mb-10 text-center">Add Link</h4><form name="linkForm" ng-submit="closeLinkModal(linkForm,link,$event)" novalidate><label>Link URL</label><input type="text" class="form-control input-sm" ng-pattern="pat.linkUrl" ng-model="link" required /><div class="mt-15 text-right"><button class="btn btn-xs btn-default sharp remove" type="reset" style="margin-right: 5px">Cancel</button><button class="btn btn-xs btn-info sharp" type="submit">Add Link</button></div></div></form></div>');$("body").append(t).addClass("hp");a(t)(q);$(t).on("click",".remove",function(u){$(t).remove();e(q.range);$("body").removeClass("hp")})})};q.closeLinkModal=function(u,w,v){if(u.$invalid){return}e(q.range);var t=angular.element(v.target);$(t).closest(".html-preview").remove();$("body").removeClass("hp");if(q.linkE){q.range.selectNode(q.linkE[0]);q.exeCmd("createLink",w)}else{if(!w.toUpperCase().startsWith("HTTP://")&&!w.toUpperCase().startsWith("HTTPS://")){w="http://"+w}var s='<a href="'+w+'">'+(o()||w)+"</a>";q.exeCmd("insertHTML",s)}};q.showImgModal=function(t){q.range=k();q.imgE=t;q.image={WIDTH_AUTO:true};if(t){var s=t.attr("width");if(typeof s!==typeof undefined&&s!==false){q.image.WIDTH_AUTO=false;q.image.WIDTH=t.attr("width")}q.image.URL=t.attr("src");q.image.ALT=t.attr("alt")}b(function(){var u=$('<div class="html-preview"></div>');$(u).append('<div class="frame f"><h4 class="mb-10 text-center">Add Image</h4><form name="imageForm" ng-submit="closeImgModal(imageForm,image,$event)" novalidate><div class="row"><div class="col-xs-12 mb-15"><label>Image URL</label><input type="text" class="form-control input-sm" ng-pattern="pat.imageUrl" ng-model="image.URL" required></div></div><div class="row"><div class="col-xs-6"><label>Title</label><input type="text" class="form-control input-sm" ng-model="image.ALT"></div><div class="col-xs-6"><label>Width</label><input type="text" class="form-control input-sm" ng-model="image.WIDTH" required ng-if="!image.WIDTH_AUTO" inp-validation="onlyDigits" maxlength="3"><p class="mt-5"><label class="checkbox-inline f-14"><input type="checkbox" ng-model="image.WIDTH_AUTO"> <span>Auto Width</span></label><p></div></div><div class="mt-15 text-right"><button class="btn btn-xs btn-default sharp remove" type="reset"  style="margin-right: 5px">Cancel</button><button class="btn btn-xs btn-info sharp" type="submit">Add Image</button></div></form></div>');$("body").append(u).addClass("hp");a(u)(q);$(u).on("click",".remove",function(v){$(u).remove();e(q.range);$("body").removeClass("hp")})})};q.closeImgModal=function(u,w,v){if(u.$invalid){return}e(q.range);var t=angular.element(v.target);$(t).closest(".html-preview").remove();$("body").removeClass("hp");if(q.imgE){q.range.selectNode(q.imgE[0]);q.exeCmd("delete",0,null)}var s='<img src="'+w.URL+'"'+(w.ALT?('alt="'+w.ALT+'"'):"")+(!w.WIDTH_AUTO?('width="'+w.WIDTH+'"'):"")+"/>";q.exeCmd("insertHTML",s)};q.getColor=function(s){q.range=k();c.get(function(t){e(q.range);if(s){q.exeCmd("backColor",t)}else{q.exeCmd("foreColor",t)}})};q.$watch("htmlData",function(){if(!q.local){q.setData(j)}else{q.local=false}});q.setData=function(s){$(s).html(q.htmlData||"");$(s).find("*").addClass("he-e");if(q.is_ie||q.is_ff){p(s,1)}l()};q.getData=function(){var s=$(j).clone();$(s).find("*").removeAttr("class");if(q.is_ie||q.is_ff){d(s[0],1);q.htmlData=$(s).html()}else{q.htmlData=$(s).html()}s=""};q.showPreview=function(){var s=$('<div class="html-preview"></div>');$(s).append('<p class="text-right mb-10 f-16"><i class="glyphicon glyphicon-remove pointer c-white remove"></i></p><div class="frame">'+q.htmlData+"</div>");$("body").append(s).addClass("hp");$(s).on("click",".remove",function(t){$(s).remove();$("body").removeClass("hp")})};q.pat={imageUrl:/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\(\)\*\+,;=.]+(?:png|jpg|jpeg|gif|svg)+$/,linkUrl:/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/};q.commands={backColor:{cmd:"backColor",val:"color"},bold:{cmd:"bold"},copy:{cmd:"copy"},createLink:{cmd:"createLink"},formatBlock:{cmd:"formatBlock"},cut:{cmd:"cut"},"delete":{cmd:"delete"},fontName:{cmd:"fontName"},fontSize:{cmd:"fontSize"},foreColor:{cmd:"foreColor"},forwardDelete:{cmd:"forwardDelete"},indent:{cmd:"indent"},insertHorizontalRule:{cmd:"insertHorizontalRule"},insertImage:{cmd:"insertImage"},insertOrderedList:{cmd:"insertOrderedList"},insertUnorderedList:{cmd:"insertUnorderedList"},insertParagraph:{cmd:"insertParagraph"},insertText:{cmd:"insertText"},italic:{cmd:"italic"},justifyCenter:{cmd:"justifyCenter"},justifyFull:{cmd:"justifyFull"},justifyLeft:{cmd:"justifyLeft"},justifyRight:{cmd:"justifyRight"},outdent:{cmd:"outdent"},paste:{cmd:"paste"},redo:{cmd:"redo"},removeFormat:{cmd:"removeFormat"},selectAll:{cmd:"selectAll"},strikeThrough:{cmd:"strikeThrough"},subscript:{cmd:"subscript"},superscript:{cmd:"superscript"},underline:{cmd:"underline"},undo:{cmd:"undo"},unlink:{cmd:"unlink"},insertHTML:{cmd:"insertHTML"},heading:{cmd:"heading"}};q.FONTS=["Arial","Helvetica","Times New Roman","Times","Courier New","Courier","Verdana","Georgia","Palatino","Garamond","Bookman","Comic Sans MS","Trebuchet MS","Arial Black","Impact"];for(var n in q.commands){q.commands[n].support=document.queryCommandSupported(n)}function k(){if(window.getSelection){i=window.getSelection();if(i.getRangeAt&&i.rangeCount){return i.getRangeAt(0)}}else{if(document.selection&&document.selection.createRange){return document.selection.createRange()}}return null}function e(s){if(s){if(window.getSelection){i=window.getSelection();i.removeAllRanges();i.addRange(s)}else{if(document.selection&&s.select){s.select()}}}}function g(){for(var s in q.commands){if(document.queryCommandSupported(s)){q.commands[s].enabled=document.queryCommandState(s)}}}function f(){$(j).find("*").addClass("he-e");$(j).find("blockquote").css({"font-size":"inherit",border:"0 solid transparent",padding:"0",margin:"0 0 0 20px"});$(j).find("a").attr("target","_blank");q.local=true;q.getData()}function o(){var s="";if(window.getSelection){s=window.getSelection().toString()}else{if(document.selection&&document.selection.type!="Control"){s=document.selection.createRange().text}}return s}function r(u,s){var y,t;if(window.getSelection){y=window.getSelection();if(y.getRangeAt&&y.rangeCount){t=y.getRangeAt(0);t.deleteContents();var v=document.createElement("div");if(s){v.textContent=u}else{v.innerHTML=u}var z=document.createDocumentFragment(),x,w;while((x=v.firstChild)){w=z.appendChild(x)}t.insertNode(z);if(w){t=t.cloneRange();t.setStartAfter(w);t.collapse(true);y.removeAllRanges();y.addRange(t)}}}}function d(u,t){if(!t&&u.nodeType==1&&!/(script|style)/i.test(u.tagName)){var s=$(u).attr("align");if(typeof s!==typeof undefined&&s!==false){if(s!="left"){$(u).css("text-align",s)}$(u).removeAttr("align")}}$.each(u.childNodes,function(v,w){d(w)})}function p(u,t){if(!t&&u.nodeType==1&&!/(script|style)/i.test(u.tagName)){if($(u).attr("style")&&$(u).attr("style").indexOf("text-align")!=-1){var s=$(u).css("text-align");if(s){if(s.indexOf("center")!=-1){$(u).attr("align","center")}else{if(s.indexOf("right")!=-1){$(u).attr("align","right")}else{$(u).attr("align","left")}}$(u).css("text-align","")}}}$.each(u.childNodes,function(v,w){p(w)})}function l(){b(function(){q.words=[];h(j,1);q.count=q.words.length})}function h(v,t){if(!t&&v.nodeType==3){var u=v.textContent.trim();var s=u.length?u.replace(/\s+/g," ").split(" "):[];q.words=q.words.concat(s)}$.each(v.childNodes,function(w,x){h(x)})}$(document).ready(function(){$('[data-toggle="tooltip"]').tooltip("destroy").tooltip({container:"body"});if(q.is_ie){function t(v){v.preventDefault()}document.body.addEventListener("mscontrolselect",t)}try{var s=document.createElement("input");s.type="color";s.value="!";if(s.type==="color"&&s.value!=="!"){q.commands.foreColor.support=true;q.commands.backColor.support=true}}catch(u){}})}}}]).factory("getColor",function(){return{get:function(c){var b=$("#getColor");if(!b.length){b=$('<input type="color" id="getColor" style="display:none">');$("body").append(b)}b.unbind("change");b.change(function a(){if(this.value){c(this.value)}this.value=""});b.click()}}});